# Build and package konf-lsp for installation

# Default recipe
default: build-all

# Build everything (LSP + extension)
build-all: build-lsp build-extension

# Build the LSP server in release mode
build-lsp:
    cargo +nightly build --release

# Build the LSP server in debug mode
build-lsp-debug:
    cargo +nightly build

# Install extension dependencies
install-deps:
    cd vscode-extension && bun install

# Build the VSCode extension
build-extension: install-deps
    cd vscode-extension && bun run compile

# Package the VSCode extension as .vsix
package-extension: build-extension
    cd vscode-extension && bun run package

# Build and package everything for installation
package: build-lsp package-extension
    @echo ""
    @echo "Build complete!"
    @echo ""
    @echo "LSP binary: target/release/konf-lsp"
    @echo "VSCode extension: vscode-extension/konf-provider-*.vsix"
    @echo ""
    @echo "To install the extension in VSCode:"
    @echo "  1. Open VSCode"
    @echo "  2. Cmd+Shift+P -> 'Extensions: Install from VSIX...'"
    @echo "  3. Select vscode-extension/konf-provider-*.vsix"

# Install the extension in VSCode (macOS/Linux)
install: package
    #!/usr/bin/env bash
    vsix_file=$(ls vscode-extension/*.vsix 2>/dev/null | head -1)
    if [ -n "$vsix_file" ]; then
        code --install-extension "$vsix_file"
        echo "Extension installed!"
    else
        echo "Error: No .vsix file found"
        exit 1
    fi

# Clean build artifacts
clean:
    cargo clean
    rm -rf vscode-extension/out
    rm -rf vscode-extension/node_modules
    rm -f vscode-extension/*.vsix

# Run the LSP server directly (for testing)
run:
    cargo +nightly run

# Check code without building
check:
    cargo +nightly check

# Run clippy linter
lint:
    cargo +nightly clippy

# Add konf-lsp to PATH (creates symlink in ~/.local/bin)
add-to-path: build-lsp
    #!/usr/bin/env bash
    set -e

    # Ensure ~/.local/bin exists
    mkdir -p ~/.local/bin

    # Find the binary (supports custom target dirs like sccache)
    bin_path=$(cargo +nightly build --release --message-format=json 2>/dev/null \
        | jq -r 'select(.executable != null) | .executable' \
        | grep konf-lsp | head -1)

    if [ -z "$bin_path" ] || [ ! -f "$bin_path" ]; then
        echo "Error: Could not find konf-lsp binary"
        exit 1
    fi

    # Create symlink
    ln -sf "$bin_path" ~/.local/bin/konf-lsp

    echo "Symlink created: ~/.local/bin/konf-lsp -> $bin_path"
    echo ""

    # Check if ~/.local/bin is in PATH
    if [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
        echo "⚠️  ~/.local/bin is not in your PATH"
        echo ""
        echo "Add this to your shell config (~/.zshrc or ~/.bashrc):"
        echo '  export PATH="$HOME/.local/bin:$PATH"'
        echo ""
        echo "Then reload your shell or run:"
        echo "  source ~/.zshrc"
    else
        echo "✓ konf-lsp is now available in PATH"
        echo "  Run 'konf-lsp --help' to verify"
    fi
